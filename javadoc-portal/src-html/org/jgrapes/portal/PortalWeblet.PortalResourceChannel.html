<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
<head>
<title>Source code</title>
<link rel="stylesheet" type="text/css" href="../../../../stylesheet.css" title="Style">
</head>
<body>
<div class="sourceContainer">
<pre><span class="sourceLineNo">001</span><a name="line.1">/*</a>
<span class="sourceLineNo">002</span><a name="line.2"> * JGrapes Event Driven Framework</a>
<span class="sourceLineNo">003</span><a name="line.3"> * Copyright (C) 2017-2018 Michael N. Lipp</a>
<span class="sourceLineNo">004</span><a name="line.4"> * </a>
<span class="sourceLineNo">005</span><a name="line.5"> * This program is free software; you can redistribute it and/or modify it </a>
<span class="sourceLineNo">006</span><a name="line.6"> * under the terms of the GNU General Public License as published by </a>
<span class="sourceLineNo">007</span><a name="line.7"> * the Free Software Foundation; either version 3 of the License, or </a>
<span class="sourceLineNo">008</span><a name="line.8"> * (at your option) any later version.</a>
<span class="sourceLineNo">009</span><a name="line.9"> * </a>
<span class="sourceLineNo">010</span><a name="line.10"> * This program is distributed in the hope that it will be useful, but </a>
<span class="sourceLineNo">011</span><a name="line.11"> * WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY</a>
<span class="sourceLineNo">012</span><a name="line.12"> * or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License </a>
<span class="sourceLineNo">013</span><a name="line.13"> * for more details.</a>
<span class="sourceLineNo">014</span><a name="line.14"> * </a>
<span class="sourceLineNo">015</span><a name="line.15"> * You should have received a copy of the GNU General Public License along </a>
<span class="sourceLineNo">016</span><a name="line.16"> * with this program; if not, see &lt;http://www.gnu.org/licenses/&gt;.</a>
<span class="sourceLineNo">017</span><a name="line.17"> */</a>
<span class="sourceLineNo">018</span><a name="line.18"></a>
<span class="sourceLineNo">019</span><a name="line.19">package org.jgrapes.portal;</a>
<span class="sourceLineNo">020</span><a name="line.20"></a>
<span class="sourceLineNo">021</span><a name="line.21">import freemarker.template.Configuration;</a>
<span class="sourceLineNo">022</span><a name="line.22">import freemarker.template.SimpleScalar;</a>
<span class="sourceLineNo">023</span><a name="line.23">import freemarker.template.Template;</a>
<span class="sourceLineNo">024</span><a name="line.24">import freemarker.template.TemplateException;</a>
<span class="sourceLineNo">025</span><a name="line.25">import freemarker.template.TemplateExceptionHandler;</a>
<span class="sourceLineNo">026</span><a name="line.26">import freemarker.template.TemplateMethodModelEx;</a>
<span class="sourceLineNo">027</span><a name="line.27">import freemarker.template.TemplateModel;</a>
<span class="sourceLineNo">028</span><a name="line.28">import freemarker.template.TemplateModelException;</a>
<span class="sourceLineNo">029</span><a name="line.29"></a>
<span class="sourceLineNo">030</span><a name="line.30">import java.io.IOException;</a>
<span class="sourceLineNo">031</span><a name="line.31">import java.io.OutputStreamWriter;</a>
<span class="sourceLineNo">032</span><a name="line.32">import java.io.UnsupportedEncodingException;</a>
<span class="sourceLineNo">033</span><a name="line.33">import java.io.Writer;</a>
<span class="sourceLineNo">034</span><a name="line.34">import java.net.URI;</a>
<span class="sourceLineNo">035</span><a name="line.35">import java.net.URISyntaxException;</a>
<span class="sourceLineNo">036</span><a name="line.36">import java.net.URL;</a>
<span class="sourceLineNo">037</span><a name="line.37">import java.nio.CharBuffer;</a>
<span class="sourceLineNo">038</span><a name="line.38">import java.text.Collator;</a>
<span class="sourceLineNo">039</span><a name="line.39">import java.text.ParseException;</a>
<span class="sourceLineNo">040</span><a name="line.40">import java.util.Collections;</a>
<span class="sourceLineNo">041</span><a name="line.41">import java.util.Comparator;</a>
<span class="sourceLineNo">042</span><a name="line.42">import java.util.HashMap;</a>
<span class="sourceLineNo">043</span><a name="line.43">import java.util.HashSet;</a>
<span class="sourceLineNo">044</span><a name="line.44">import java.util.List;</a>
<span class="sourceLineNo">045</span><a name="line.45">import java.util.Locale;</a>
<span class="sourceLineNo">046</span><a name="line.46">import java.util.Map;</a>
<span class="sourceLineNo">047</span><a name="line.47">import java.util.MissingResourceException;</a>
<span class="sourceLineNo">048</span><a name="line.48">import java.util.Optional;</a>
<span class="sourceLineNo">049</span><a name="line.49">import java.util.ResourceBundle;</a>
<span class="sourceLineNo">050</span><a name="line.50">import java.util.ServiceLoader;</a>
<span class="sourceLineNo">051</span><a name="line.51">import java.util.Set;</a>
<span class="sourceLineNo">052</span><a name="line.52">import java.util.UUID;</a>
<span class="sourceLineNo">053</span><a name="line.53">import java.util.concurrent.ConcurrentHashMap;</a>
<span class="sourceLineNo">054</span><a name="line.54">import java.util.function.BiFunction;</a>
<span class="sourceLineNo">055</span><a name="line.55">import java.util.function.Function;</a>
<span class="sourceLineNo">056</span><a name="line.56">import java.util.stream.StreamSupport;</a>
<span class="sourceLineNo">057</span><a name="line.57"></a>
<span class="sourceLineNo">058</span><a name="line.58">import org.jdrupes.httpcodec.protocols.http.HttpConstants.HttpStatus;</a>
<span class="sourceLineNo">059</span><a name="line.59">import org.jdrupes.httpcodec.protocols.http.HttpField;</a>
<span class="sourceLineNo">060</span><a name="line.60">import org.jdrupes.httpcodec.protocols.http.HttpResponse;</a>
<span class="sourceLineNo">061</span><a name="line.61">import org.jdrupes.httpcodec.types.Converters;</a>
<span class="sourceLineNo">062</span><a name="line.62">import org.jdrupes.httpcodec.types.MediaType;</a>
<span class="sourceLineNo">063</span><a name="line.63">import org.jdrupes.json.JsonDecodeException;</a>
<span class="sourceLineNo">064</span><a name="line.64">import org.jgrapes.core.Channel;</a>
<span class="sourceLineNo">065</span><a name="line.65">import org.jgrapes.core.ClassChannel;</a>
<span class="sourceLineNo">066</span><a name="line.66">import org.jgrapes.core.Component;</a>
<span class="sourceLineNo">067</span><a name="line.67">import org.jgrapes.core.EventPipeline;</a>
<span class="sourceLineNo">068</span><a name="line.68">import org.jgrapes.core.Manager;</a>
<span class="sourceLineNo">069</span><a name="line.69">import org.jgrapes.core.annotation.Handler;</a>
<span class="sourceLineNo">070</span><a name="line.70">import org.jgrapes.core.annotation.HandlerDefinition.ChannelReplacements;</a>
<span class="sourceLineNo">071</span><a name="line.71">import org.jgrapes.http.LanguageSelector.Selection;</a>
<span class="sourceLineNo">072</span><a name="line.72">import org.jgrapes.http.ResourcePattern;</a>
<span class="sourceLineNo">073</span><a name="line.73">import org.jgrapes.http.ResponseCreationSupport;</a>
<span class="sourceLineNo">074</span><a name="line.74">import org.jgrapes.http.Session;</a>
<span class="sourceLineNo">075</span><a name="line.75">import org.jgrapes.http.annotation.RequestHandler;</a>
<span class="sourceLineNo">076</span><a name="line.76">import org.jgrapes.http.events.GetRequest;</a>
<span class="sourceLineNo">077</span><a name="line.77">import org.jgrapes.http.events.ProtocolSwitchAccepted;</a>
<span class="sourceLineNo">078</span><a name="line.78">import org.jgrapes.http.events.Request;</a>
<span class="sourceLineNo">079</span><a name="line.79">import org.jgrapes.http.events.Response;</a>
<span class="sourceLineNo">080</span><a name="line.80">import org.jgrapes.http.events.Upgraded;</a>
<span class="sourceLineNo">081</span><a name="line.81">import org.jgrapes.io.IOSubchannel;</a>
<span class="sourceLineNo">082</span><a name="line.82">import org.jgrapes.io.events.Closed;</a>
<span class="sourceLineNo">083</span><a name="line.83">import org.jgrapes.io.events.Input;</a>
<span class="sourceLineNo">084</span><a name="line.84">import org.jgrapes.io.events.Output;</a>
<span class="sourceLineNo">085</span><a name="line.85">import org.jgrapes.io.util.ByteBufferOutputStream;</a>
<span class="sourceLineNo">086</span><a name="line.86">import org.jgrapes.io.util.CharBufferWriter;</a>
<span class="sourceLineNo">087</span><a name="line.87">import org.jgrapes.io.util.LinkedIOSubchannel;</a>
<span class="sourceLineNo">088</span><a name="line.88">import org.jgrapes.portal.events.PageResourceRequest;</a>
<span class="sourceLineNo">089</span><a name="line.89">import org.jgrapes.portal.events.PortalCommand;</a>
<span class="sourceLineNo">090</span><a name="line.90">import org.jgrapes.portal.events.PortalReady;</a>
<span class="sourceLineNo">091</span><a name="line.91">import org.jgrapes.portal.events.PortletResourceRequest;</a>
<span class="sourceLineNo">092</span><a name="line.92">import org.jgrapes.portal.events.ResourceRequestCompleted;</a>
<span class="sourceLineNo">093</span><a name="line.93">import org.jgrapes.portal.events.SetLocale;</a>
<span class="sourceLineNo">094</span><a name="line.94">import org.jgrapes.portal.events.SetTheme;</a>
<span class="sourceLineNo">095</span><a name="line.95">import org.jgrapes.portal.events.SimplePortalCommand;</a>
<span class="sourceLineNo">096</span><a name="line.96">import org.jgrapes.portal.themes.base.Provider;</a>
<span class="sourceLineNo">097</span><a name="line.97">import org.jgrapes.util.events.KeyValueStoreData;</a>
<span class="sourceLineNo">098</span><a name="line.98">import org.jgrapes.util.events.KeyValueStoreQuery;</a>
<span class="sourceLineNo">099</span><a name="line.99">import org.jgrapes.util.events.KeyValueStoreUpdate;</a>
<span class="sourceLineNo">100</span><a name="line.100"></a>
<span class="sourceLineNo">101</span><a name="line.101">/**</a>
<span class="sourceLineNo">102</span><a name="line.102"> * Provides resources using {@link Request}/{@link Response}</a>
<span class="sourceLineNo">103</span><a name="line.103"> * events. Some resource requests (page resource, portlet resource)</a>
<span class="sourceLineNo">104</span><a name="line.104"> * are forwarded via the {@link Portal} component to the portlets.</a>
<span class="sourceLineNo">105</span><a name="line.105"> */</a>
<span class="sourceLineNo">106</span><a name="line.106">@SuppressWarnings({ "PMD.ExcessiveImports", "PMD.NcssCount",</a>
<span class="sourceLineNo">107</span><a name="line.107">    "PMD.TooManyMethods" })</a>
<span class="sourceLineNo">108</span><a name="line.108">public class PortalWeblet extends Component {</a>
<span class="sourceLineNo">109</span><a name="line.109"></a>
<span class="sourceLineNo">110</span><a name="line.110">    private static final String PORTAL_SESSION_IDS</a>
<span class="sourceLineNo">111</span><a name="line.111">        = PortalWeblet.class.getName() + ".portalSessionId";</a>
<span class="sourceLineNo">112</span><a name="line.112">    private static final String UTF_8 = "utf-8";</a>
<span class="sourceLineNo">113</span><a name="line.113">    @SuppressWarnings("PMD.VariableNamingConventions")</a>
<span class="sourceLineNo">114</span><a name="line.114">    private static final Configuration fmConfig = createFmConfig();</a>
<span class="sourceLineNo">115</span><a name="line.115"></a>
<span class="sourceLineNo">116</span><a name="line.116">    private final Portal portal;</a>
<span class="sourceLineNo">117</span><a name="line.117">    private ResourcePattern requestPattern;</a>
<span class="sourceLineNo">118</span><a name="line.118">    private ServiceLoader&lt;ThemeProvider&gt; themeLoader;</a>
<span class="sourceLineNo">119</span><a name="line.119"></a>
<span class="sourceLineNo">120</span><a name="line.120">    private Function&lt;Locale, ResourceBundle&gt; resourceBundleSupplier;</a>
<span class="sourceLineNo">121</span><a name="line.121">    private BiFunction&lt;ThemeProvider, String, URL&gt; fallbackResourceSupplier</a>
<span class="sourceLineNo">122</span><a name="line.122">        = (themeProvider, resource) -&gt; {</a>
<span class="sourceLineNo">123</span><a name="line.123">            return null;</a>
<span class="sourceLineNo">124</span><a name="line.124">        };</a>
<span class="sourceLineNo">125</span><a name="line.125">    private final Set&lt;Locale&gt; supportedLocales;</a>
<span class="sourceLineNo">126</span><a name="line.126"></a>
<span class="sourceLineNo">127</span><a name="line.127">    private final ThemeProvider baseTheme;</a>
<span class="sourceLineNo">128</span><a name="line.128">    private Map&lt;String, Object&gt; portalBaseModel;</a>
<span class="sourceLineNo">129</span><a name="line.129">    private final RenderSupport renderSupport = new RenderSupportImpl();</a>
<span class="sourceLineNo">130</span><a name="line.130">    private boolean useMinifiedResources = true;</a>
<span class="sourceLineNo">131</span><a name="line.131">    private long psNetworkTimeout = 45000;</a>
<span class="sourceLineNo">132</span><a name="line.132">    private long psRefreshInterval = 30000;</a>
<span class="sourceLineNo">133</span><a name="line.133">    private long psInactivityTimeout = -1;</a>
<span class="sourceLineNo">134</span><a name="line.134"></a>
<span class="sourceLineNo">135</span><a name="line.135">    /**</a>
<span class="sourceLineNo">136</span><a name="line.136">     * The class used in handler annotations to represent the </a>
<span class="sourceLineNo">137</span><a name="line.137">     * portal channel.</a>
<span class="sourceLineNo">138</span><a name="line.138">     */</a>
<span class="sourceLineNo">139</span><a name="line.139">    private class PortalChannel extends ClassChannel {</a>
<span class="sourceLineNo">140</span><a name="line.140">    }</a>
<span class="sourceLineNo">141</span><a name="line.141"></a>
<span class="sourceLineNo">142</span><a name="line.142">    private static Configuration createFmConfig() {</a>
<span class="sourceLineNo">143</span><a name="line.143">        Configuration fmConfig</a>
<span class="sourceLineNo">144</span><a name="line.144">            = new Configuration(Configuration.VERSION_2_3_26);</a>
<span class="sourceLineNo">145</span><a name="line.145">        fmConfig.setClassLoaderForTemplateLoading(</a>
<span class="sourceLineNo">146</span><a name="line.146">            PortalWeblet.class.getClassLoader(), "org/jgrapes/portal");</a>
<span class="sourceLineNo">147</span><a name="line.147">        fmConfig.setDefaultEncoding(UTF_8);</a>
<span class="sourceLineNo">148</span><a name="line.148">        fmConfig.setTemplateExceptionHandler(</a>
<span class="sourceLineNo">149</span><a name="line.149">            TemplateExceptionHandler.RETHROW_HANDLER);</a>
<span class="sourceLineNo">150</span><a name="line.150">        fmConfig.setLogTemplateExceptions(false);</a>
<span class="sourceLineNo">151</span><a name="line.151">        return fmConfig;</a>
<span class="sourceLineNo">152</span><a name="line.152">    }</a>
<span class="sourceLineNo">153</span><a name="line.153"></a>
<span class="sourceLineNo">154</span><a name="line.154">    /**</a>
<span class="sourceLineNo">155</span><a name="line.155">     * Instantiates a new portal weblet.</a>
<span class="sourceLineNo">156</span><a name="line.156">     *</a>
<span class="sourceLineNo">157</span><a name="line.157">     * @param webletChannel the weblet channel</a>
<span class="sourceLineNo">158</span><a name="line.158">     * @param portal the portal</a>
<span class="sourceLineNo">159</span><a name="line.159">     */</a>
<span class="sourceLineNo">160</span><a name="line.160">    @SuppressWarnings("PMD.UseStringBufferForStringAppends")</a>
<span class="sourceLineNo">161</span><a name="line.161">    public PortalWeblet(Channel webletChannel, Portal portal) {</a>
<span class="sourceLineNo">162</span><a name="line.162">        super(webletChannel, ChannelReplacements.create()</a>
<span class="sourceLineNo">163</span><a name="line.163">            .add(PortalChannel.class, portal.channel()));</a>
<span class="sourceLineNo">164</span><a name="line.164">        this.portal = portal;</a>
<span class="sourceLineNo">165</span><a name="line.165">        String portalPath = portal.prefix().getPath();</a>
<span class="sourceLineNo">166</span><a name="line.166">        if (portalPath.endsWith("/")) {</a>
<span class="sourceLineNo">167</span><a name="line.167">            portalPath = portalPath.substring(0, portalPath.length() - 1);</a>
<span class="sourceLineNo">168</span><a name="line.168">        }</a>
<span class="sourceLineNo">169</span><a name="line.169">        portalPath = portalPath + "|**";</a>
<span class="sourceLineNo">170</span><a name="line.170">        try {</a>
<span class="sourceLineNo">171</span><a name="line.171">            requestPattern = new ResourcePattern(portalPath);</a>
<span class="sourceLineNo">172</span><a name="line.172">        } catch (ParseException e) {</a>
<span class="sourceLineNo">173</span><a name="line.173">            throw new IllegalArgumentException(e);</a>
<span class="sourceLineNo">174</span><a name="line.174">        }</a>
<span class="sourceLineNo">175</span><a name="line.175"></a>
<span class="sourceLineNo">176</span><a name="line.176">        baseTheme = new Provider();</a>
<span class="sourceLineNo">177</span><a name="line.177"></a>
<span class="sourceLineNo">178</span><a name="line.178">        supportedLocales = new HashSet&lt;&gt;();</a>
<span class="sourceLineNo">179</span><a name="line.179">        for (Locale locale : Locale.getAvailableLocales()) {</a>
<span class="sourceLineNo">180</span><a name="line.180">            if (locale.getLanguage().equals("")) {</a>
<span class="sourceLineNo">181</span><a name="line.181">                continue;</a>
<span class="sourceLineNo">182</span><a name="line.182">            }</a>
<span class="sourceLineNo">183</span><a name="line.183">            if (resourceBundleSupplier != null) {</a>
<span class="sourceLineNo">184</span><a name="line.184">                ResourceBundle bundle = resourceBundleSupplier.apply(locale);</a>
<span class="sourceLineNo">185</span><a name="line.185">                if (bundle.getLocale().equals(locale)) {</a>
<span class="sourceLineNo">186</span><a name="line.186">                    supportedLocales.add(locale);</a>
<span class="sourceLineNo">187</span><a name="line.187">                }</a>
<span class="sourceLineNo">188</span><a name="line.188">            }</a>
<span class="sourceLineNo">189</span><a name="line.189">            ResourceBundle bundle = ResourceBundle.getBundle(getClass()</a>
<span class="sourceLineNo">190</span><a name="line.190">                .getPackage().getName() + ".l10n", locale);</a>
<span class="sourceLineNo">191</span><a name="line.191">            if (bundle.getLocale().equals(locale)) {</a>
<span class="sourceLineNo">192</span><a name="line.192">                supportedLocales.add(locale);</a>
<span class="sourceLineNo">193</span><a name="line.193">            }</a>
<span class="sourceLineNo">194</span><a name="line.194">        }</a>
<span class="sourceLineNo">195</span><a name="line.195"></a>
<span class="sourceLineNo">196</span><a name="line.196">        RequestHandler.Evaluator.add(this, "onGet", portal.prefix() + "**");</a>
<span class="sourceLineNo">197</span><a name="line.197">        RequestHandler.Evaluator.add(this, "onGetRedirect",</a>
<span class="sourceLineNo">198</span><a name="line.198">            portal.prefix().getPath().substring(</a>
<span class="sourceLineNo">199</span><a name="line.199">                0, portal.prefix().getPath().length() - 1));</a>
<span class="sourceLineNo">200</span><a name="line.200"></a>
<span class="sourceLineNo">201</span><a name="line.201">        portalBaseModel = createPortalBaseModel();</a>
<span class="sourceLineNo">202</span><a name="line.202">    }</a>
<span class="sourceLineNo">203</span><a name="line.203"></a>
<span class="sourceLineNo">204</span><a name="line.204">    private Map&lt;String, Object&gt; createPortalBaseModel() {</a>
<span class="sourceLineNo">205</span><a name="line.205">        // Create portal model</a>
<span class="sourceLineNo">206</span><a name="line.206">        portalBaseModel = new HashMap&lt;&gt;();</a>
<span class="sourceLineNo">207</span><a name="line.207">        portalBaseModel.put("resourceUrl", new TemplateMethodModelEx() {</a>
<span class="sourceLineNo">208</span><a name="line.208">            @Override</a>
<span class="sourceLineNo">209</span><a name="line.209">            public Object exec(@SuppressWarnings("rawtypes") List arguments)</a>
<span class="sourceLineNo">210</span><a name="line.210">                    throws TemplateModelException {</a>
<span class="sourceLineNo">211</span><a name="line.211">                @SuppressWarnings({ "unchecked", "PMD.AvoidDuplicateLiterals" })</a>
<span class="sourceLineNo">212</span><a name="line.212">                List&lt;TemplateModel&gt; args = (List&lt;TemplateModel&gt;) arguments;</a>
<span class="sourceLineNo">213</span><a name="line.213">                if (!(args.get(0) instanceof SimpleScalar)) {</a>
<span class="sourceLineNo">214</span><a name="line.214">                    throw new TemplateModelException("Not a string.");</a>
<span class="sourceLineNo">215</span><a name="line.215">                }</a>
<span class="sourceLineNo">216</span><a name="line.216">                return portal.prefix().resolve(</a>
<span class="sourceLineNo">217</span><a name="line.217">                    ((SimpleScalar) args.get(0)).getAsString()).getRawPath();</a>
<span class="sourceLineNo">218</span><a name="line.218">            }</a>
<span class="sourceLineNo">219</span><a name="line.219">        });</a>
<span class="sourceLineNo">220</span><a name="line.220">        portalBaseModel.put("useMinifiedResources", useMinifiedResources);</a>
<span class="sourceLineNo">221</span><a name="line.221">        portalBaseModel.put("minifiedExtension",</a>
<span class="sourceLineNo">222</span><a name="line.222">            useMinifiedResources ? ".min" : "");</a>
<span class="sourceLineNo">223</span><a name="line.223">        portalBaseModel.put(</a>
<span class="sourceLineNo">224</span><a name="line.224">            "portalSessionRefreshInterval", psRefreshInterval);</a>
<span class="sourceLineNo">225</span><a name="line.225">        portalBaseModel.put(</a>
<span class="sourceLineNo">226</span><a name="line.226">            "portalSessionInactivityTimeout", psInactivityTimeout);</a>
<span class="sourceLineNo">227</span><a name="line.227">        return Collections.unmodifiableMap(portalBaseModel);</a>
<span class="sourceLineNo">228</span><a name="line.228">    }</a>
<span class="sourceLineNo">229</span><a name="line.229"></a>
<span class="sourceLineNo">230</span><a name="line.230">    /**</a>
<span class="sourceLineNo">231</span><a name="line.231">     * Sets the portal session network timeout. The portal session will be</a>
<span class="sourceLineNo">232</span><a name="line.232">     * removed if no messages have been received from the portal session</a>
<span class="sourceLineNo">233</span><a name="line.233">     * for the given number of milliseconds. The value defaults to 45 seconds.</a>
<span class="sourceLineNo">234</span><a name="line.234">     * </a>
<span class="sourceLineNo">235</span><a name="line.235">     * @param timeout the timeout in milli seconds</a>
<span class="sourceLineNo">236</span><a name="line.236">     * @return the portal view for easy chaining</a>
<span class="sourceLineNo">237</span><a name="line.237">     */</a>
<span class="sourceLineNo">238</span><a name="line.238">    public PortalWeblet setPortalSessionNetworkTimeout(long timeout) {</a>
<span class="sourceLineNo">239</span><a name="line.239">        psNetworkTimeout = timeout;</a>
<span class="sourceLineNo">240</span><a name="line.240">        return this;</a>
<span class="sourceLineNo">241</span><a name="line.241">    }</a>
<span class="sourceLineNo">242</span><a name="line.242"></a>
<span class="sourceLineNo">243</span><a name="line.243">    /**</a>
<span class="sourceLineNo">244</span><a name="line.244">     * Sets the portal session refresh interval. The portal code in the</a>
<span class="sourceLineNo">245</span><a name="line.245">     * browser will send a keep alive packet if there has been no user</a>
<span class="sourceLineNo">246</span><a name="line.246">     * activity for more than the given number of milliseconds. The value </a>
<span class="sourceLineNo">247</span><a name="line.247">     * defaults to 30 seconds.</a>
<span class="sourceLineNo">248</span><a name="line.248">     * </a>
<span class="sourceLineNo">249</span><a name="line.249">     * @param interval the interval in milliseconds</a>
<span class="sourceLineNo">250</span><a name="line.250">     * @return the portal view for easy chaining</a>
<span class="sourceLineNo">251</span><a name="line.251">     */</a>
<span class="sourceLineNo">252</span><a name="line.252">    public PortalWeblet setPortalSessionRefreshInterval(long interval) {</a>
<span class="sourceLineNo">253</span><a name="line.253">        psRefreshInterval = interval;</a>
<span class="sourceLineNo">254</span><a name="line.254">        portalBaseModel = createPortalBaseModel();</a>
<span class="sourceLineNo">255</span><a name="line.255">        return this;</a>
<span class="sourceLineNo">256</span><a name="line.256">    }</a>
<span class="sourceLineNo">257</span><a name="line.257"></a>
<span class="sourceLineNo">258</span><a name="line.258">    /**</a>
<span class="sourceLineNo">259</span><a name="line.259">     * Sets the portal session inactivity timeout. If there has been no</a>
<span class="sourceLineNo">260</span><a name="line.260">     * user activity for more than the given number of milliseconds the</a>
<span class="sourceLineNo">261</span><a name="line.261">     * portal code stops sending keep alive packets and displays a</a>
<span class="sourceLineNo">262</span><a name="line.262">     * message to the user. The value defaults to -1 (no timeout).</a>
<span class="sourceLineNo">263</span><a name="line.263">     * </a>
<span class="sourceLineNo">264</span><a name="line.264">     * @param timeout the timeout in milliseconds</a>
<span class="sourceLineNo">265</span><a name="line.265">     * @return the portal view for easy chaining</a>
<span class="sourceLineNo">266</span><a name="line.266">     */</a>
<span class="sourceLineNo">267</span><a name="line.267">    public PortalWeblet setPortalSessionInactivityTimeout(long timeout) {</a>
<span class="sourceLineNo">268</span><a name="line.268">        psInactivityTimeout = timeout;</a>
<span class="sourceLineNo">269</span><a name="line.269">        portalBaseModel = createPortalBaseModel();</a>
<span class="sourceLineNo">270</span><a name="line.270">        return this;</a>
<span class="sourceLineNo">271</span><a name="line.271">    }</a>
<span class="sourceLineNo">272</span><a name="line.272"></a>
<span class="sourceLineNo">273</span><a name="line.273">    /**</a>
<span class="sourceLineNo">274</span><a name="line.274">     * Returns whether resources are minified.</a>
<span class="sourceLineNo">275</span><a name="line.275">     *</a>
<span class="sourceLineNo">276</span><a name="line.276">     * @return the useMinifiedResources</a>
<span class="sourceLineNo">277</span><a name="line.277">     */</a>
<span class="sourceLineNo">278</span><a name="line.278">    public boolean useMinifiedResources() {</a>
<span class="sourceLineNo">279</span><a name="line.279">        return useMinifiedResources;</a>
<span class="sourceLineNo">280</span><a name="line.280">    }</a>
<span class="sourceLineNo">281</span><a name="line.281"></a>
<span class="sourceLineNo">282</span><a name="line.282">    /**</a>
<span class="sourceLineNo">283</span><a name="line.283">     * Determines if resources are minified.</a>
<span class="sourceLineNo">284</span><a name="line.284">     *</a>
<span class="sourceLineNo">285</span><a name="line.285">     * @param useMinifiedResources the useMinifiedResources to set</a>
<span class="sourceLineNo">286</span><a name="line.286">     */</a>
<span class="sourceLineNo">287</span><a name="line.287">    public void setUseMinifiedResources(boolean useMinifiedResources) {</a>
<span class="sourceLineNo">288</span><a name="line.288">        this.useMinifiedResources = useMinifiedResources;</a>
<span class="sourceLineNo">289</span><a name="line.289">        portalBaseModel = createPortalBaseModel();</a>
<span class="sourceLineNo">290</span><a name="line.290">    }</a>
<span class="sourceLineNo">291</span><a name="line.291"></a>
<span class="sourceLineNo">292</span><a name="line.292">    /**</a>
<span class="sourceLineNo">293</span><a name="line.293">     * The service loader must be created lazily, else the OSGi</a>
<span class="sourceLineNo">294</span><a name="line.294">     * service mediator doesn't work properly.</a>
<span class="sourceLineNo">295</span><a name="line.295">     * </a>
<span class="sourceLineNo">296</span><a name="line.296">     * @return</a>
<span class="sourceLineNo">297</span><a name="line.297">     */</a>
<span class="sourceLineNo">298</span><a name="line.298">    private ServiceLoader&lt;ThemeProvider&gt; themeLoader() {</a>
<span class="sourceLineNo">299</span><a name="line.299">        if (themeLoader != null) {</a>
<span class="sourceLineNo">300</span><a name="line.300">            return themeLoader;</a>
<span class="sourceLineNo">301</span><a name="line.301">        }</a>
<span class="sourceLineNo">302</span><a name="line.302">        return themeLoader = ServiceLoader.load(ThemeProvider.class);</a>
<span class="sourceLineNo">303</span><a name="line.303">    }</a>
<span class="sourceLineNo">304</span><a name="line.304"></a>
<span class="sourceLineNo">305</span><a name="line.305">    /* default */ void setResourceBundleSupplier(</a>
<span class="sourceLineNo">306</span><a name="line.306">            Function&lt;Locale, ResourceBundle&gt; supplier) {</a>
<span class="sourceLineNo">307</span><a name="line.307">        this.resourceBundleSupplier = supplier;</a>
<span class="sourceLineNo">308</span><a name="line.308">    }</a>
<span class="sourceLineNo">309</span><a name="line.309"></a>
<span class="sourceLineNo">310</span><a name="line.310">    /* default */ void setFallbackResourceSupplier(</a>
<span class="sourceLineNo">311</span><a name="line.311">            BiFunction&lt;ThemeProvider, String, URL&gt; supplier) {</a>
<span class="sourceLineNo">312</span><a name="line.312">        this.fallbackResourceSupplier = supplier;</a>
<span class="sourceLineNo">313</span><a name="line.313">    }</a>
<span class="sourceLineNo">314</span><a name="line.314"></a>
<span class="sourceLineNo">315</span><a name="line.315">    /* default */ RenderSupport renderSupport() {</a>
<span class="sourceLineNo">316</span><a name="line.316">        return renderSupport;</a>
<span class="sourceLineNo">317</span><a name="line.317">    }</a>
<span class="sourceLineNo">318</span><a name="line.318"></a>
<span class="sourceLineNo">319</span><a name="line.319">    /**</a>
<span class="sourceLineNo">320</span><a name="line.320">     * Redirects `GET` requests without trailing slash.</a>
<span class="sourceLineNo">321</span><a name="line.321">     *</a>
<span class="sourceLineNo">322</span><a name="line.322">     * @param event the event</a>
<span class="sourceLineNo">323</span><a name="line.323">     * @param channel the channel</a>
<span class="sourceLineNo">324</span><a name="line.324">     * @throws InterruptedException the interrupted exception</a>
<span class="sourceLineNo">325</span><a name="line.325">     * @throws IOException Signals that an I/O exception has occurred.</a>
<span class="sourceLineNo">326</span><a name="line.326">     * @throws ParseException the parse exception</a>
<span class="sourceLineNo">327</span><a name="line.327">     */</a>
<span class="sourceLineNo">328</span><a name="line.328">    @RequestHandler(dynamic = true)</a>
<span class="sourceLineNo">329</span><a name="line.329">    @SuppressWarnings("PMD.EmptyCatchBlock")</a>
<span class="sourceLineNo">330</span><a name="line.330">    public void onGetRedirect(GetRequest event, IOSubchannel channel)</a>
<span class="sourceLineNo">331</span><a name="line.331">            throws InterruptedException, IOException, ParseException {</a>
<span class="sourceLineNo">332</span><a name="line.332">        HttpResponse response = event.httpRequest().response().get();</a>
<span class="sourceLineNo">333</span><a name="line.333">        response.setStatus(HttpStatus.MOVED_PERMANENTLY)</a>
<span class="sourceLineNo">334</span><a name="line.334">            .setContentType("text", "plain", UTF_8)</a>
<span class="sourceLineNo">335</span><a name="line.335">            .setField(HttpField.LOCATION, portal.prefix());</a>
<span class="sourceLineNo">336</span><a name="line.336">        channel.respond(new Response(response));</a>
<span class="sourceLineNo">337</span><a name="line.337">        try {</a>
<span class="sourceLineNo">338</span><a name="line.338">            channel.respond(Output.from(portal.prefix().toString()</a>
<span class="sourceLineNo">339</span><a name="line.339">                .getBytes(UTF_8), true));</a>
<span class="sourceLineNo">340</span><a name="line.340">        } catch (UnsupportedEncodingException e) {</a>
<span class="sourceLineNo">341</span><a name="line.341">            // Supported by definition</a>
<span class="sourceLineNo">342</span><a name="line.342">        }</a>
<span class="sourceLineNo">343</span><a name="line.343">        event.setResult(true);</a>
<span class="sourceLineNo">344</span><a name="line.344">        event.stop();</a>
<span class="sourceLineNo">345</span><a name="line.345">    }</a>
<span class="sourceLineNo">346</span><a name="line.346"></a>
<span class="sourceLineNo">347</span><a name="line.347">    /**</a>
<span class="sourceLineNo">348</span><a name="line.348">     * Handle the `GET` requests for the various resources.</a>
<span class="sourceLineNo">349</span><a name="line.349">     *</a>
<span class="sourceLineNo">350</span><a name="line.350">     * @param event the event</a>
<span class="sourceLineNo">351</span><a name="line.351">     * @param channel the channel</a>
<span class="sourceLineNo">352</span><a name="line.352">     * @throws InterruptedException the interrupted exception</a>
<span class="sourceLineNo">353</span><a name="line.353">     * @throws IOException Signals that an I/O exception has occurred.</a>
<span class="sourceLineNo">354</span><a name="line.354">     * @throws ParseException the parse exception</a>
<span class="sourceLineNo">355</span><a name="line.355">     */</a>
<span class="sourceLineNo">356</span><a name="line.356">    @RequestHandler(dynamic = true)</a>
<span class="sourceLineNo">357</span><a name="line.357">    public void onGet(GetRequest event, IOSubchannel channel)</a>
<span class="sourceLineNo">358</span><a name="line.358">            throws InterruptedException, IOException, ParseException {</a>
<span class="sourceLineNo">359</span><a name="line.359">        URI requestUri = event.requestUri();</a>
<span class="sourceLineNo">360</span><a name="line.360">        int prefixSegs = requestPattern.matches(requestUri);</a>
<span class="sourceLineNo">361</span><a name="line.361">        // Request for portal? (Only valid with session)</a>
<span class="sourceLineNo">362</span><a name="line.362">        if (prefixSegs &lt; 0 || !event.associated(Session.class).isPresent()) {</a>
<span class="sourceLineNo">363</span><a name="line.363">            return;</a>
<span class="sourceLineNo">364</span><a name="line.364">        }</a>
<span class="sourceLineNo">365</span><a name="line.365"></a>
<span class="sourceLineNo">366</span><a name="line.366">        // Normalize and evaluate</a>
<span class="sourceLineNo">367</span><a name="line.367">        String requestPath = ResourcePattern.removeSegments(</a>
<span class="sourceLineNo">368</span><a name="line.368">            requestUri.getPath(), prefixSegs + 1);</a>
<span class="sourceLineNo">369</span><a name="line.369">        String[] requestParts = ResourcePattern.split(requestPath, 1);</a>
<span class="sourceLineNo">370</span><a name="line.370">        switch (requestParts[0]) {</a>
<span class="sourceLineNo">371</span><a name="line.371">        case "":</a>
<span class="sourceLineNo">372</span><a name="line.372">            renderPortal(event, channel);</a>
<span class="sourceLineNo">373</span><a name="line.373">            return;</a>
<span class="sourceLineNo">374</span><a name="line.374">        case "portal-resource":</a>
<span class="sourceLineNo">375</span><a name="line.375">            ResponseCreationSupport.sendStaticContent(event, channel,</a>
<span class="sourceLineNo">376</span><a name="line.376">                path -&gt; getClass().getResource(</a>
<span class="sourceLineNo">377</span><a name="line.377">                    requestParts[1]),</a>
<span class="sourceLineNo">378</span><a name="line.378">                null);</a>
<span class="sourceLineNo">379</span><a name="line.379">            return;</a>
<span class="sourceLineNo">380</span><a name="line.380">        case "page-resource":</a>
<span class="sourceLineNo">381</span><a name="line.381">            requestPageResource(event, channel, requestParts[1]);</a>
<span class="sourceLineNo">382</span><a name="line.382">            return;</a>
<span class="sourceLineNo">383</span><a name="line.383">        case "portal-session":</a>
<span class="sourceLineNo">384</span><a name="line.384">            handleSessionRequest(event, channel, requestParts[1]);</a>
<span class="sourceLineNo">385</span><a name="line.385">            return;</a>
<span class="sourceLineNo">386</span><a name="line.386">        case "theme-resource":</a>
<span class="sourceLineNo">387</span><a name="line.387">            sendThemeResource(event, channel, requestParts[1]);</a>
<span class="sourceLineNo">388</span><a name="line.388">            return;</a>
<span class="sourceLineNo">389</span><a name="line.389">        case "portlet-resource":</a>
<span class="sourceLineNo">390</span><a name="line.390">            requestPortletResource(event, channel, URI.create(requestParts[1]));</a>
<span class="sourceLineNo">391</span><a name="line.391">            return;</a>
<span class="sourceLineNo">392</span><a name="line.392">        default:</a>
<span class="sourceLineNo">393</span><a name="line.393">            break;</a>
<span class="sourceLineNo">394</span><a name="line.394">        }</a>
<span class="sourceLineNo">395</span><a name="line.395">    }</a>
<span class="sourceLineNo">396</span><a name="line.396"></a>
<span class="sourceLineNo">397</span><a name="line.397">    @SuppressWarnings({ "PMD.ExcessiveMethodLength",</a>
<span class="sourceLineNo">398</span><a name="line.398">        "PMD.DataflowAnomalyAnalysis" })</a>
<span class="sourceLineNo">399</span><a name="line.399">    private void renderPortal(GetRequest event, IOSubchannel channel)</a>
<span class="sourceLineNo">400</span><a name="line.400">            throws IOException, InterruptedException {</a>
<span class="sourceLineNo">401</span><a name="line.401">        event.setResult(true);</a>
<span class="sourceLineNo">402</span><a name="line.402">        event.stop();</a>
<span class="sourceLineNo">403</span><a name="line.403"></a>
<span class="sourceLineNo">404</span><a name="line.404">        // Because language is changed via websocket, locale cookie</a>
<span class="sourceLineNo">405</span><a name="line.405">        // may be out-dated</a>
<span class="sourceLineNo">406</span><a name="line.406">        event.associated(Selection.class)</a>
<span class="sourceLineNo">407</span><a name="line.407">            .ifPresent(selection -&gt; selection.prefer(selection.get()[0]));</a>
<span class="sourceLineNo">408</span><a name="line.408"></a>
<span class="sourceLineNo">409</span><a name="line.409">        // This is a portal session now (can be connected to)</a>
<span class="sourceLineNo">410</span><a name="line.410">        Session session = event.associated(Session.class).get();</a>
<span class="sourceLineNo">411</span><a name="line.411">        UUID portalSessionId = UUID.randomUUID();</a>
<span class="sourceLineNo">412</span><a name="line.412">        @SuppressWarnings("unchecked")</a>
<span class="sourceLineNo">413</span><a name="line.413">        Map&lt;URI, UUID&gt; knownIds = (Map&lt;URI, UUID&gt;) session.computeIfAbsent(</a>
<span class="sourceLineNo">414</span><a name="line.414">            PORTAL_SESSION_IDS,</a>
<span class="sourceLineNo">415</span><a name="line.415">            newKey -&gt; new ConcurrentHashMap&lt;URI, UUID&gt;());</a>
<span class="sourceLineNo">416</span><a name="line.416">        knownIds.put(portal.prefix(), portalSessionId);</a>
<span class="sourceLineNo">417</span><a name="line.417"></a>
<span class="sourceLineNo">418</span><a name="line.418">        // Prepare response</a>
<span class="sourceLineNo">419</span><a name="line.419">        HttpResponse response = event.httpRequest().response().get();</a>
<span class="sourceLineNo">420</span><a name="line.420">        MediaType mediaType = MediaType.builder().setType("text", "html")</a>
<span class="sourceLineNo">421</span><a name="line.421">            .setParameter("charset", "utf-8").build();</a>
<span class="sourceLineNo">422</span><a name="line.422">        response.setField(HttpField.CONTENT_TYPE, mediaType);</a>
<span class="sourceLineNo">423</span><a name="line.423">        response.setStatus(HttpStatus.OK);</a>
<span class="sourceLineNo">424</span><a name="line.424">        response.setHasPayload(true);</a>
<span class="sourceLineNo">425</span><a name="line.425">        channel.respond(new Response(response));</a>
<span class="sourceLineNo">426</span><a name="line.426">        try (ByteBufferOutputStream bbos = new ByteBufferOutputStream(</a>
<span class="sourceLineNo">427</span><a name="line.427">            channel, channel.responsePipeline());</a>
<span class="sourceLineNo">428</span><a name="line.428">                Writer out = new OutputStreamWriter(bbos.suppressClose(),</a>
<span class="sourceLineNo">429</span><a name="line.429">                    "utf-8")) {</a>
<span class="sourceLineNo">430</span><a name="line.430">            @SuppressWarnings("PMD.UseConcurrentHashMap")</a>
<span class="sourceLineNo">431</span><a name="line.431">            Map&lt;String, Object&gt; portalModel = new HashMap&lt;&gt;(portalBaseModel);</a>
<span class="sourceLineNo">432</span><a name="line.432"></a>
<span class="sourceLineNo">433</span><a name="line.433">            // Portal Session UUID</a>
<span class="sourceLineNo">434</span><a name="line.434">            portalModel.put("portalSessionId", portalSessionId.toString());</a>
<span class="sourceLineNo">435</span><a name="line.435"></a>
<span class="sourceLineNo">436</span><a name="line.436">            // Add locale</a>
<span class="sourceLineNo">437</span><a name="line.437">            final Locale locale = event.associated(Selection.class).map(</a>
<span class="sourceLineNo">438</span><a name="line.438">                sel -&gt; sel.get()[0]).orElse(Locale.getDefault());</a>
<span class="sourceLineNo">439</span><a name="line.439">            portalModel.put("locale", locale);</a>
<span class="sourceLineNo">440</span><a name="line.440"></a>
<span class="sourceLineNo">441</span><a name="line.441">            // Add supported locales</a>
<span class="sourceLineNo">442</span><a name="line.442">            final Collator coll = Collator.getInstance(locale);</a>
<span class="sourceLineNo">443</span><a name="line.443">            final Comparator&lt;LanguageInfo&gt; comp</a>
<span class="sourceLineNo">444</span><a name="line.444">                = new Comparator&lt;PortalWeblet.LanguageInfo&gt;() {</a>
<span class="sourceLineNo">445</span><a name="line.445">                    @Override</a>
<span class="sourceLineNo">446</span><a name="line.446">                    public int compare(LanguageInfo o1, LanguageInfo o2) {</a>
<span class="sourceLineNo">447</span><a name="line.447">                        return coll.compare(o1.getLabel(), o2.getLabel());</a>
<span class="sourceLineNo">448</span><a name="line.448">                    }</a>
<span class="sourceLineNo">449</span><a name="line.449">                };</a>
<span class="sourceLineNo">450</span><a name="line.450">            LanguageInfo[] languages = supportedLocales.stream()</a>
<span class="sourceLineNo">451</span><a name="line.451">                .map(lang -&gt; new LanguageInfo(lang))</a>
<span class="sourceLineNo">452</span><a name="line.452">                .sorted(comp).toArray(size -&gt; new LanguageInfo[size]);</a>
<span class="sourceLineNo">453</span><a name="line.453">            portalModel.put("supportedLanguages", languages);</a>
<span class="sourceLineNo">454</span><a name="line.454"></a>
<span class="sourceLineNo">455</span><a name="line.455">            // Add localization</a>
<span class="sourceLineNo">456</span><a name="line.456">            final ResourceBundle additionalResources</a>
<span class="sourceLineNo">457</span><a name="line.457">                = resourceBundleSupplier == null</a>
<span class="sourceLineNo">458</span><a name="line.458">                    ? null</a>
<span class="sourceLineNo">459</span><a name="line.459">                    : resourceBundleSupplier.apply(locale);</a>
<span class="sourceLineNo">460</span><a name="line.460">            final ResourceBundle baseResources = ResourceBundle.getBundle(</a>
<span class="sourceLineNo">461</span><a name="line.461">                getClass().getPackage().getName() + ".l10n", locale,</a>
<span class="sourceLineNo">462</span><a name="line.462">                ResourceBundle.Control.getNoFallbackControl(</a>
<span class="sourceLineNo">463</span><a name="line.463">                    ResourceBundle.Control.FORMAT_DEFAULT));</a>
<span class="sourceLineNo">464</span><a name="line.464">            portalModel.put("_", new TemplateMethodModelEx() {</a>
<span class="sourceLineNo">465</span><a name="line.465">                @Override</a>
<span class="sourceLineNo">466</span><a name="line.466">                public Object exec(@SuppressWarnings("rawtypes") List arguments)</a>
<span class="sourceLineNo">467</span><a name="line.467">                        throws TemplateModelException {</a>
<span class="sourceLineNo">468</span><a name="line.468">                    @SuppressWarnings("unchecked")</a>
<span class="sourceLineNo">469</span><a name="line.469">                    List&lt;TemplateModel&gt; args = (List&lt;TemplateModel&gt;) arguments;</a>
<span class="sourceLineNo">470</span><a name="line.470">                    if (!(args.get(0) instanceof SimpleScalar)) {</a>
<span class="sourceLineNo">471</span><a name="line.471">                        throw new TemplateModelException("Not a string.");</a>
<span class="sourceLineNo">472</span><a name="line.472">                    }</a>
<span class="sourceLineNo">473</span><a name="line.473">                    String key = ((SimpleScalar) args.get(0)).getAsString();</a>
<span class="sourceLineNo">474</span><a name="line.474">                    try {</a>
<span class="sourceLineNo">475</span><a name="line.475">                        return additionalResources.getString(key);</a>
<span class="sourceLineNo">476</span><a name="line.476">                    } catch (MissingResourceException e) { // NOPMD</a>
<span class="sourceLineNo">477</span><a name="line.477">                        // try base resources</a>
<span class="sourceLineNo">478</span><a name="line.478">                    }</a>
<span class="sourceLineNo">479</span><a name="line.479">                    try {</a>
<span class="sourceLineNo">480</span><a name="line.480">                        return baseResources.getString(key);</a>
<span class="sourceLineNo">481</span><a name="line.481">                    } catch (MissingResourceException e) { // NOPMD</a>
<span class="sourceLineNo">482</span><a name="line.482">                        // no luck</a>
<span class="sourceLineNo">483</span><a name="line.483">                    }</a>
<span class="sourceLineNo">484</span><a name="line.484">                    return key;</a>
<span class="sourceLineNo">485</span><a name="line.485">                }</a>
<span class="sourceLineNo">486</span><a name="line.486">            });</a>
<span class="sourceLineNo">487</span><a name="line.487"></a>
<span class="sourceLineNo">488</span><a name="line.488">            // Add themes. Doing this on every reload allows themes</a>
<span class="sourceLineNo">489</span><a name="line.489">            // to be added dynamically. Note that we must load again</a>
<span class="sourceLineNo">490</span><a name="line.490">            // (not reload) in order for this to work in an OSGi environment.</a>
<span class="sourceLineNo">491</span><a name="line.491">            themeLoader = ServiceLoader.load(ThemeProvider.class);</a>
<span class="sourceLineNo">492</span><a name="line.492">            portalModel.put("themeInfos",</a>
<span class="sourceLineNo">493</span><a name="line.493">                StreamSupport.stream(themeLoader().spliterator(), false)</a>
<span class="sourceLineNo">494</span><a name="line.494">                    .map(thi -&gt; new ThemeInfo(thi.themeId(), thi.themeName()))</a>
<span class="sourceLineNo">495</span><a name="line.495">                    .sorted().toArray(size -&gt; new ThemeInfo[size]));</a>
<span class="sourceLineNo">496</span><a name="line.496"></a>
<span class="sourceLineNo">497</span><a name="line.497">            Template tpl = fmConfig.getTemplate("portal.ftlh");</a>
<span class="sourceLineNo">498</span><a name="line.498">            tpl.process(portalModel, out);</a>
<span class="sourceLineNo">499</span><a name="line.499">        } catch (TemplateException e) {</a>
<span class="sourceLineNo">500</span><a name="line.500">            throw new IOException(e);</a>
<span class="sourceLineNo">501</span><a name="line.501">        }</a>
<span class="sourceLineNo">502</span><a name="line.502">    }</a>
<span class="sourceLineNo">503</span><a name="line.503"></a>
<span class="sourceLineNo">504</span><a name="line.504">    @SuppressWarnings("PMD.DataflowAnomalyAnalysis")</a>
<span class="sourceLineNo">505</span><a name="line.505">    private void sendThemeResource(GetRequest event, IOSubchannel channel,</a>
<span class="sourceLineNo">506</span><a name="line.506">            String resource) throws ParseException {</a>
<span class="sourceLineNo">507</span><a name="line.507">        // Get resource</a>
<span class="sourceLineNo">508</span><a name="line.508">        ThemeProvider themeProvider = event.associated(Session.class).flatMap(</a>
<span class="sourceLineNo">509</span><a name="line.509">            session -&gt; Optional.ofNullable(session.get("themeProvider"))</a>
<span class="sourceLineNo">510</span><a name="line.510">                .flatMap(</a>
<span class="sourceLineNo">511</span><a name="line.511">                    themeId -&gt; StreamSupport</a>
<span class="sourceLineNo">512</span><a name="line.512">                        .stream(themeLoader().spliterator(), false)</a>
<span class="sourceLineNo">513</span><a name="line.513">                        .filter(thi -&gt; thi.themeId().equals(themeId))</a>
<span class="sourceLineNo">514</span><a name="line.514">                        .findFirst()))</a>
<span class="sourceLineNo">515</span><a name="line.515">            .orElse(baseTheme);</a>
<span class="sourceLineNo">516</span><a name="line.516">        URL resourceUrl;</a>
<span class="sourceLineNo">517</span><a name="line.517">        try {</a>
<span class="sourceLineNo">518</span><a name="line.518">            resourceUrl = themeProvider.getResource(resource);</a>
<span class="sourceLineNo">519</span><a name="line.519">        } catch (ResourceNotFoundException e) {</a>
<span class="sourceLineNo">520</span><a name="line.520">            try {</a>
<span class="sourceLineNo">521</span><a name="line.521">                resourceUrl = baseTheme.getResource(resource);</a>
<span class="sourceLineNo">522</span><a name="line.522">            } catch (ResourceNotFoundException e1) {</a>
<span class="sourceLineNo">523</span><a name="line.523">                resourceUrl</a>
<span class="sourceLineNo">524</span><a name="line.524">                    = fallbackResourceSupplier.apply(themeProvider, resource);</a>
<span class="sourceLineNo">525</span><a name="line.525">                if (resourceUrl == null) {</a>
<span class="sourceLineNo">526</span><a name="line.526">                    return;</a>
<span class="sourceLineNo">527</span><a name="line.527">                }</a>
<span class="sourceLineNo">528</span><a name="line.528">            }</a>
<span class="sourceLineNo">529</span><a name="line.529">        }</a>
<span class="sourceLineNo">530</span><a name="line.530">        final URL resUrl = resourceUrl;</a>
<span class="sourceLineNo">531</span><a name="line.531">        ResponseCreationSupport.sendStaticContent(event, channel,</a>
<span class="sourceLineNo">532</span><a name="line.532">            path -&gt; resUrl, null);</a>
<span class="sourceLineNo">533</span><a name="line.533">    }</a>
<span class="sourceLineNo">534</span><a name="line.534"></a>
<span class="sourceLineNo">535</span><a name="line.535">    private void requestPageResource(GetRequest event, IOSubchannel channel,</a>
<span class="sourceLineNo">536</span><a name="line.536">            String resource) throws InterruptedException {</a>
<span class="sourceLineNo">537</span><a name="line.537">        // Send events to providers on portal's channel</a>
<span class="sourceLineNo">538</span><a name="line.538">        PageResourceRequest pageResourceRequest = new PageResourceRequest(</a>
<span class="sourceLineNo">539</span><a name="line.539">            uriFromPath(resource),</a>
<span class="sourceLineNo">540</span><a name="line.540">            event.httpRequest().findValue(HttpField.IF_MODIFIED_SINCE,</a>
<span class="sourceLineNo">541</span><a name="line.541">                Converters.DATE_TIME).orElse(null),</a>
<span class="sourceLineNo">542</span><a name="line.542">            event.httpRequest(), channel, renderSupport());</a>
<span class="sourceLineNo">543</span><a name="line.543">        // Make session available (associate with event, this is not</a>
<span class="sourceLineNo">544</span><a name="line.544">        // a websocket request).</a>
<span class="sourceLineNo">545</span><a name="line.545">        event.associated(Session.class).ifPresent(</a>
<span class="sourceLineNo">546</span><a name="line.546">            session -&gt; pageResourceRequest.setAssociated(Session.class,</a>
<span class="sourceLineNo">547</span><a name="line.547">                session));</a>
<span class="sourceLineNo">548</span><a name="line.548">        event.setResult(true);</a>
<span class="sourceLineNo">549</span><a name="line.549">        event.stop();</a>
<span class="sourceLineNo">550</span><a name="line.550">        fire(pageResourceRequest, portalChannel(channel));</a>
<span class="sourceLineNo">551</span><a name="line.551">    }</a>
<span class="sourceLineNo">552</span><a name="line.552"></a>
<span class="sourceLineNo">553</span><a name="line.553">    private void requestPortletResource(GetRequest event, IOSubchannel channel,</a>
<span class="sourceLineNo">554</span><a name="line.554">            URI resource) throws InterruptedException {</a>
<span class="sourceLineNo">555</span><a name="line.555">        String resPath = resource.getPath();</a>
<span class="sourceLineNo">556</span><a name="line.556">        int sep = resPath.indexOf('/');</a>
<span class="sourceLineNo">557</span><a name="line.557">        // Send events to portlets on portal's channel</a>
<span class="sourceLineNo">558</span><a name="line.558">        PortletResourceRequest portletRequest = new PortletResourceRequest(</a>
<span class="sourceLineNo">559</span><a name="line.559">            resPath.substring(0, sep),</a>
<span class="sourceLineNo">560</span><a name="line.560">            uriFromPath(resPath.substring(sep + 1)),</a>
<span class="sourceLineNo">561</span><a name="line.561">            event.httpRequest().findValue(HttpField.IF_MODIFIED_SINCE,</a>
<span class="sourceLineNo">562</span><a name="line.562">                Converters.DATE_TIME).orElse(null),</a>
<span class="sourceLineNo">563</span><a name="line.563">            event.httpRequest(), channel, renderSupport());</a>
<span class="sourceLineNo">564</span><a name="line.564">        // Make session available (associate with event, this is not</a>
<span class="sourceLineNo">565</span><a name="line.565">        // a websocket request).</a>
<span class="sourceLineNo">566</span><a name="line.566">        event.associated(Session.class).ifPresent(</a>
<span class="sourceLineNo">567</span><a name="line.567">            session -&gt; portletRequest.setAssociated(Session.class, session));</a>
<span class="sourceLineNo">568</span><a name="line.568">        event.setResult(true);</a>
<span class="sourceLineNo">569</span><a name="line.569">        event.stop();</a>
<span class="sourceLineNo">570</span><a name="line.570">        fire(portletRequest, portalChannel(channel));</a>
<span class="sourceLineNo">571</span><a name="line.571">    }</a>
<span class="sourceLineNo">572</span><a name="line.572"></a>
<span class="sourceLineNo">573</span><a name="line.573">    /**</a>
<span class="sourceLineNo">574</span><a name="line.574">     * The portal channel for getting resources. Resource providers</a>
<span class="sourceLineNo">575</span><a name="line.575">     * respond on the same event pipeline as they receive, because</a>
<span class="sourceLineNo">576</span><a name="line.576">     * handling is just a mapping to {@link ResourceRequestCompleted}.</a>
<span class="sourceLineNo">577</span><a name="line.577">     *</a>
<span class="sourceLineNo">578</span><a name="line.578">     * @param channel the channel</a>
<span class="sourceLineNo">579</span><a name="line.579">     * @return the IO subchannel</a>
<span class="sourceLineNo">580</span><a name="line.580">     */</a>
<span class="sourceLineNo">581</span><a name="line.581">    private IOSubchannel portalChannel(IOSubchannel channel) {</a>
<span class="sourceLineNo">582</span><a name="line.582">        @SuppressWarnings("unchecked")</a>
<span class="sourceLineNo">583</span><a name="line.583">        Optional&lt;LinkedIOSubchannel&gt; portalChannel</a>
<span class="sourceLineNo">584</span><a name="line.584">            = (Optional&lt;LinkedIOSubchannel&gt;) LinkedIOSubchannel</a>
<span class="sourceLineNo">585</span><a name="line.585">                .downstreamChannel(portal, channel);</a>
<span class="sourceLineNo">586</span><a name="line.586">        return portalChannel.orElseGet(</a>
<span class="sourceLineNo">587</span><a name="line.587">            () -&gt; new PortalResourceChannel(</a>
<span class="sourceLineNo">588</span><a name="line.588">                portal, channel, activeEventPipeline()));</a>
<span class="sourceLineNo">589</span><a name="line.589">    }</a>
<span class="sourceLineNo">590</span><a name="line.590"></a>
<span class="sourceLineNo">591</span><a name="line.591">    /**</a>
<span class="sourceLineNo">592</span><a name="line.592">     * Handles the {@link ResourceRequestCompleted} event.</a>
<span class="sourceLineNo">593</span><a name="line.593">     *</a>
<span class="sourceLineNo">594</span><a name="line.594">     * @param event the event</a>
<span class="sourceLineNo">595</span><a name="line.595">     * @param channel the channel</a>
<span class="sourceLineNo">596</span><a name="line.596">     * @throws IOException Signals that an I/O exception has occurred.</a>
<span class="sourceLineNo">597</span><a name="line.597">     * @throws InterruptedException the interrupted exception</a>
<span class="sourceLineNo">598</span><a name="line.598">     */</a>
<span class="sourceLineNo">599</span><a name="line.599">    @Handler(channels = PortalChannel.class)</a>
<span class="sourceLineNo">600</span><a name="line.600">    public void onResourceRequestCompleted(</a>
<span class="sourceLineNo">601</span><a name="line.601">            ResourceRequestCompleted event, PortalResourceChannel channel)</a>
<span class="sourceLineNo">602</span><a name="line.602">            throws IOException, InterruptedException {</a>
<span class="sourceLineNo">603</span><a name="line.603">        event.stop();</a>
<span class="sourceLineNo">604</span><a name="line.604">        if (event.event().get() == null) {</a>
<span class="sourceLineNo">605</span><a name="line.605">            ResponseCreationSupport.sendResponse(event.event().httpRequest(),</a>
<span class="sourceLineNo">606</span><a name="line.606">                event.event().httpChannel(), HttpStatus.NOT_FOUND);</a>
<span class="sourceLineNo">607</span><a name="line.607">            return;</a>
<span class="sourceLineNo">608</span><a name="line.608">        }</a>
<span class="sourceLineNo">609</span><a name="line.609">        event.event().get().process();</a>
<span class="sourceLineNo">610</span><a name="line.610">    }</a>
<span class="sourceLineNo">611</span><a name="line.611"></a>
<span class="sourceLineNo">612</span><a name="line.612">    private void handleSessionRequest(</a>
<span class="sourceLineNo">613</span><a name="line.613">            GetRequest event, IOSubchannel channel, String portalSessionId)</a>
<span class="sourceLineNo">614</span><a name="line.614">            throws InterruptedException, IOException, ParseException {</a>
<span class="sourceLineNo">615</span><a name="line.615">        // Must be WebSocket request.</a>
<span class="sourceLineNo">616</span><a name="line.616">        if (!event.httpRequest().findField(</a>
<span class="sourceLineNo">617</span><a name="line.617">            HttpField.UPGRADE, Converters.STRING_LIST)</a>
<span class="sourceLineNo">618</span><a name="line.618">            .map(fld -&gt; fld.value().containsIgnoreCase("websocket"))</a>
<span class="sourceLineNo">619</span><a name="line.619">            .orElse(false)) {</a>
<span class="sourceLineNo">620</span><a name="line.620">            return;</a>
<span class="sourceLineNo">621</span><a name="line.621">        }</a>
<span class="sourceLineNo">622</span><a name="line.622"></a>
<span class="sourceLineNo">623</span><a name="line.623">        // Can only connect to sessions that have been prepared</a>
<span class="sourceLineNo">624</span><a name="line.624">        // by loading the portal. (Prevents using a newly created</a>
<span class="sourceLineNo">625</span><a name="line.625">        // browser session from being (re-)connected to after a</a>
<span class="sourceLineNo">626</span><a name="line.626">        // long disconnect or restart and, of course, CSF).</a>
<span class="sourceLineNo">627</span><a name="line.627">        final Session browserSession = event.associated(Session.class).get();</a>
<span class="sourceLineNo">628</span><a name="line.628">        @SuppressWarnings("unchecked")</a>
<span class="sourceLineNo">629</span><a name="line.629">        Map&lt;URI, UUID&gt; knownIds</a>
<span class="sourceLineNo">630</span><a name="line.630">            = (Map&lt;URI, UUID&gt;) browserSession.computeIfAbsent(</a>
<span class="sourceLineNo">631</span><a name="line.631">                PORTAL_SESSION_IDS,</a>
<span class="sourceLineNo">632</span><a name="line.632">                newKey -&gt; new ConcurrentHashMap&lt;URI, UUID&gt;());</a>
<span class="sourceLineNo">633</span><a name="line.633">        if (!UUID.fromString(portalSessionId) // NOPMD, note negation</a>
<span class="sourceLineNo">634</span><a name="line.634">            .equals(knownIds.get(portal.prefix()))) {</a>
<span class="sourceLineNo">635</span><a name="line.635">            channel.setAssociated(this, new String[2]);</a>
<span class="sourceLineNo">636</span><a name="line.636">        } else {</a>
<span class="sourceLineNo">637</span><a name="line.637">            channel.setAssociated(this, new String[] {</a>
<span class="sourceLineNo">638</span><a name="line.638">                portalSessionId,</a>
<span class="sourceLineNo">639</span><a name="line.639">                Optional.ofNullable(event.httpRequest().queryData()</a>
<span class="sourceLineNo">640</span><a name="line.640">                    .get("was")).map(vals -&gt; vals.get(0)).orElse(null)</a>
<span class="sourceLineNo">641</span><a name="line.641">            });</a>
<span class="sourceLineNo">642</span><a name="line.642">        }</a>
<span class="sourceLineNo">643</span><a name="line.643">        channel.respond(new ProtocolSwitchAccepted(event, "websocket"));</a>
<span class="sourceLineNo">644</span><a name="line.644">        event.stop();</a>
<span class="sourceLineNo">645</span><a name="line.645">    }</a>
<span class="sourceLineNo">646</span><a name="line.646"></a>
<span class="sourceLineNo">647</span><a name="line.647">    /**</a>
<span class="sourceLineNo">648</span><a name="line.648">     * Called when the connection has been upgraded.</a>
<span class="sourceLineNo">649</span><a name="line.649">     *</a>
<span class="sourceLineNo">650</span><a name="line.650">     * @param event the event</a>
<span class="sourceLineNo">651</span><a name="line.651">     * @param wsChannel the ws channel</a>
<span class="sourceLineNo">652</span><a name="line.652">     * @throws IOException Signals that an I/O exception has occurred.</a>
<span class="sourceLineNo">653</span><a name="line.653">     */</a>
<span class="sourceLineNo">654</span><a name="line.654">    @Handler</a>
<span class="sourceLineNo">655</span><a name="line.655">    public void onUpgraded(Upgraded event, IOSubchannel wsChannel)</a>
<span class="sourceLineNo">656</span><a name="line.656">            throws IOException {</a>
<span class="sourceLineNo">657</span><a name="line.657">        Optional&lt;String[]&gt; passedIn</a>
<span class="sourceLineNo">658</span><a name="line.658">            = wsChannel.associated(this, String[].class);</a>
<span class="sourceLineNo">659</span><a name="line.659">        if (!passedIn.isPresent()) {</a>
<span class="sourceLineNo">660</span><a name="line.660">            return;</a>
<span class="sourceLineNo">661</span><a name="line.661">        }</a>
<span class="sourceLineNo">662</span><a name="line.662"></a>
<span class="sourceLineNo">663</span><a name="line.663">        // Check if reload required</a>
<span class="sourceLineNo">664</span><a name="line.664">        String[] portalSessionIds = passedIn.get();</a>
<span class="sourceLineNo">665</span><a name="line.665">        if (portalSessionIds[0] == null) {</a>
<span class="sourceLineNo">666</span><a name="line.666">            @SuppressWarnings("resource")</a>
<span class="sourceLineNo">667</span><a name="line.667">            CharBufferWriter out = new CharBufferWriter(wsChannel,</a>
<span class="sourceLineNo">668</span><a name="line.668">                wsChannel.responsePipeline()).suppressClose();</a>
<span class="sourceLineNo">669</span><a name="line.669">            new SimplePortalCommand("reload").toJson(out);</a>
<span class="sourceLineNo">670</span><a name="line.670">            out.close();</a>
<span class="sourceLineNo">671</span><a name="line.671">            event.stop();</a>
<span class="sourceLineNo">672</span><a name="line.672">            return;</a>
<span class="sourceLineNo">673</span><a name="line.673">        }</a>
<span class="sourceLineNo">674</span><a name="line.674"></a>
<span class="sourceLineNo">675</span><a name="line.675">        // Get portal session</a>
<span class="sourceLineNo">676</span><a name="line.676">        final Session browserSession</a>
<span class="sourceLineNo">677</span><a name="line.677">            = wsChannel.associated(Session.class).get();</a>
<span class="sourceLineNo">678</span><a name="line.678">        // Reuse old portal session if still available</a>
<span class="sourceLineNo">679</span><a name="line.679">        PortalSession portalSession = Optional.ofNullable(portalSessionIds[1])</a>
<span class="sourceLineNo">680</span><a name="line.680">            .flatMap(opsId -&gt; PortalSession.lookup(opsId))</a>
<span class="sourceLineNo">681</span><a name="line.681">            .map(session -&gt; session.replaceId(portalSessionIds[0]))</a>
<span class="sourceLineNo">682</span><a name="line.682">            .orElse(PortalSession.lookupOrCreate(portalSessionIds[0],</a>
<span class="sourceLineNo">683</span><a name="line.683">                portal, psNetworkTimeout))</a>
<span class="sourceLineNo">684</span><a name="line.684">            .setUpstreamChannel(wsChannel)</a>
<span class="sourceLineNo">685</span><a name="line.685">            .setSession(browserSession);</a>
<span class="sourceLineNo">686</span><a name="line.686">        wsChannel.setAssociated(PortalSession.class, portalSession);</a>
<span class="sourceLineNo">687</span><a name="line.687">        // Channel now used as JSON input</a>
<span class="sourceLineNo">688</span><a name="line.688">        wsChannel.setAssociated(this, new WebSocketInputReader(</a>
<span class="sourceLineNo">689</span><a name="line.689">            event.processedBy().get(), portalSession));</a>
<span class="sourceLineNo">690</span><a name="line.690">        // From now on, only portalSession.respond may be used to send on the</a>
<span class="sourceLineNo">691</span><a name="line.691">        // upstream channel.</a>
<span class="sourceLineNo">692</span><a name="line.692">        portalSession.upstreamChannel().responsePipeline()</a>
<span class="sourceLineNo">693</span><a name="line.693">            .restrictEventSource(portalSession.responsePipeline());</a>
<span class="sourceLineNo">694</span><a name="line.694">    }</a>
<span class="sourceLineNo">695</span><a name="line.695"></a>
<span class="sourceLineNo">696</span><a name="line.696">    /**</a>
<span class="sourceLineNo">697</span><a name="line.697">     * Handles network input (JSON data).</a>
<span class="sourceLineNo">698</span><a name="line.698">     *</a>
<span class="sourceLineNo">699</span><a name="line.699">     * @param event the event</a>
<span class="sourceLineNo">700</span><a name="line.700">     * @param wsChannel the ws channel</a>
<span class="sourceLineNo">701</span><a name="line.701">     * @throws IOException Signals that an I/O exception has occurred.</a>
<span class="sourceLineNo">702</span><a name="line.702">     */</a>
<span class="sourceLineNo">703</span><a name="line.703">    @Handler</a>
<span class="sourceLineNo">704</span><a name="line.704">    public void onInput(Input&lt;CharBuffer&gt; event, IOSubchannel wsChannel)</a>
<span class="sourceLineNo">705</span><a name="line.705">            throws IOException {</a>
<span class="sourceLineNo">706</span><a name="line.706">        Optional&lt;WebSocketInputReader&gt; optWsInputReader</a>
<span class="sourceLineNo">707</span><a name="line.707">            = wsChannel.associated(this, WebSocketInputReader.class);</a>
<span class="sourceLineNo">708</span><a name="line.708">        if (optWsInputReader.isPresent()) {</a>
<span class="sourceLineNo">709</span><a name="line.709">            optWsInputReader.get().write(event.buffer().backingBuffer());</a>
<span class="sourceLineNo">710</span><a name="line.710">        }</a>
<span class="sourceLineNo">711</span><a name="line.711">    }</a>
<span class="sourceLineNo">712</span><a name="line.712"></a>
<span class="sourceLineNo">713</span><a name="line.713">    /**</a>
<span class="sourceLineNo">714</span><a name="line.714">     * Handles the closed event from the web socket.</a>
<span class="sourceLineNo">715</span><a name="line.715">     *</a>
<span class="sourceLineNo">716</span><a name="line.716">     * @param event the event</a>
<span class="sourceLineNo">717</span><a name="line.717">     * @param wsChannel the WebSocket channel</a>
<span class="sourceLineNo">718</span><a name="line.718">     * @throws IOException Signals that an I/O exception has occurred.</a>
<span class="sourceLineNo">719</span><a name="line.719">     */</a>
<span class="sourceLineNo">720</span><a name="line.720">    @Handler</a>
<span class="sourceLineNo">721</span><a name="line.721">    public void onClosed(</a>
<span class="sourceLineNo">722</span><a name="line.722">            Closed event, IOSubchannel wsChannel) throws IOException {</a>
<span class="sourceLineNo">723</span><a name="line.723">        Optional&lt;WebSocketInputReader&gt; optWsInputReader</a>
<span class="sourceLineNo">724</span><a name="line.724">            = wsChannel.associated(this, WebSocketInputReader.class);</a>
<span class="sourceLineNo">725</span><a name="line.725">        if (optWsInputReader.isPresent()) {</a>
<span class="sourceLineNo">726</span><a name="line.726">            wsChannel.setAssociated(this, null);</a>
<span class="sourceLineNo">727</span><a name="line.727">            optWsInputReader.get().close();</a>
<span class="sourceLineNo">728</span><a name="line.728">        }</a>
<span class="sourceLineNo">729</span><a name="line.729">        wsChannel.associated(PortalSession.class).ifPresent(session -&gt; {</a>
<span class="sourceLineNo">730</span><a name="line.730">            // Restore channel to normal mode, see onPortalReady</a>
<span class="sourceLineNo">731</span><a name="line.731">            session.responsePipeline().restrictEventSource(null);</a>
<span class="sourceLineNo">732</span><a name="line.732">            session.disconnected();</a>
<span class="sourceLineNo">733</span><a name="line.733">        });</a>
<span class="sourceLineNo">734</span><a name="line.734">    }</a>
<span class="sourceLineNo">735</span><a name="line.735"></a>
<span class="sourceLineNo">736</span><a name="line.736">    /**</a>
<span class="sourceLineNo">737</span><a name="line.737">     * Handles the {@link PortalReady} event.</a>
<span class="sourceLineNo">738</span><a name="line.738">     *</a>
<span class="sourceLineNo">739</span><a name="line.739">     * @param event the event</a>
<span class="sourceLineNo">740</span><a name="line.740">     * @param portalSession the portal session</a>
<span class="sourceLineNo">741</span><a name="line.741">     */</a>
<span class="sourceLineNo">742</span><a name="line.742">    @Handler(channels = PortalChannel.class)</a>
<span class="sourceLineNo">743</span><a name="line.743">    public void onPortalReady(PortalReady event, PortalSession portalSession) {</a>
<span class="sourceLineNo">744</span><a name="line.744">        String principal = Utils.userFromSession(portalSession.browserSession())</a>
<span class="sourceLineNo">745</span><a name="line.745">            .map(UserPrincipal::toString).orElse("");</a>
<span class="sourceLineNo">746</span><a name="line.746">        KeyValueStoreQuery query = new KeyValueStoreQuery(</a>
<span class="sourceLineNo">747</span><a name="line.747">            "/" + principal + "/themeProvider", portalSession);</a>
<span class="sourceLineNo">748</span><a name="line.748">        fire(query, portalSession);</a>
<span class="sourceLineNo">749</span><a name="line.749">    }</a>
<span class="sourceLineNo">750</span><a name="line.750"></a>
<span class="sourceLineNo">751</span><a name="line.751">    /**</a>
<span class="sourceLineNo">752</span><a name="line.752">     * Handles the data retrieved from storage.</a>
<span class="sourceLineNo">753</span><a name="line.753">     *</a>
<span class="sourceLineNo">754</span><a name="line.754">     * @param event the event</a>
<span class="sourceLineNo">755</span><a name="line.755">     * @param channel the channel</a>
<span class="sourceLineNo">756</span><a name="line.756">     * @throws JsonDecodeException the json decode exception</a>
<span class="sourceLineNo">757</span><a name="line.757">     */</a>
<span class="sourceLineNo">758</span><a name="line.758">    @Handler(channels = PortalChannel.class)</a>
<span class="sourceLineNo">759</span><a name="line.759">    public void onKeyValueStoreData(</a>
<span class="sourceLineNo">760</span><a name="line.760">            KeyValueStoreData event, PortalSession channel)</a>
<span class="sourceLineNo">761</span><a name="line.761">            throws JsonDecodeException {</a>
<span class="sourceLineNo">762</span><a name="line.762">        Session session = channel.browserSession();</a>
<span class="sourceLineNo">763</span><a name="line.763">        String principal = Utils.userFromSession(session)</a>
<span class="sourceLineNo">764</span><a name="line.764">            .map(UserPrincipal::toString).orElse("");</a>
<span class="sourceLineNo">765</span><a name="line.765">        if (!event.event().query().equals("/" + principal + "/themeProvider")) {</a>
<span class="sourceLineNo">766</span><a name="line.766">            return;</a>
<span class="sourceLineNo">767</span><a name="line.767">        }</a>
<span class="sourceLineNo">768</span><a name="line.768">        if (!event.data().values().iterator().hasNext()) {</a>
<span class="sourceLineNo">769</span><a name="line.769">            return;</a>
<span class="sourceLineNo">770</span><a name="line.770">        }</a>
<span class="sourceLineNo">771</span><a name="line.771">        String requestedThemeId = event.data().values().iterator().next();</a>
<span class="sourceLineNo">772</span><a name="line.772">        ThemeProvider themeProvider = Optional.ofNullable(</a>
<span class="sourceLineNo">773</span><a name="line.773">            session.get("themeProvider")).flatMap(</a>
<span class="sourceLineNo">774</span><a name="line.774">                themeId -&gt; StreamSupport</a>
<span class="sourceLineNo">775</span><a name="line.775">                    .stream(themeLoader().spliterator(), false)</a>
<span class="sourceLineNo">776</span><a name="line.776">                    .filter(thi -&gt; thi.themeId().equals(themeId)).findFirst())</a>
<span class="sourceLineNo">777</span><a name="line.777">            .orElse(baseTheme);</a>
<span class="sourceLineNo">778</span><a name="line.778">        if (!themeProvider.themeId().equals(requestedThemeId)) {</a>
<span class="sourceLineNo">779</span><a name="line.779">            fire(new SetTheme(requestedThemeId), channel);</a>
<span class="sourceLineNo">780</span><a name="line.780">        }</a>
<span class="sourceLineNo">781</span><a name="line.781">    }</a>
<span class="sourceLineNo">782</span><a name="line.782"></a>
<span class="sourceLineNo">783</span><a name="line.783">    /**</a>
<span class="sourceLineNo">784</span><a name="line.784">     * Handles a change of Locale.</a>
<span class="sourceLineNo">785</span><a name="line.785">     *</a>
<span class="sourceLineNo">786</span><a name="line.786">     * @param event the event</a>
<span class="sourceLineNo">787</span><a name="line.787">     * @param channel the channel</a>
<span class="sourceLineNo">788</span><a name="line.788">     * @throws InterruptedException the interrupted exception</a>
<span class="sourceLineNo">789</span><a name="line.789">     * @throws IOException Signals that an I/O exception has occurred.</a>
<span class="sourceLineNo">790</span><a name="line.790">     */</a>
<span class="sourceLineNo">791</span><a name="line.791">    @Handler(channels = PortalChannel.class)</a>
<span class="sourceLineNo">792</span><a name="line.792">    public void onSetLocale(SetLocale event, PortalSession channel)</a>
<span class="sourceLineNo">793</span><a name="line.793">            throws InterruptedException, IOException {</a>
<span class="sourceLineNo">794</span><a name="line.794">        Session session = channel.browserSession();</a>
<span class="sourceLineNo">795</span><a name="line.795">        if (session != null) {</a>
<span class="sourceLineNo">796</span><a name="line.796">            Selection selection = (Selection) session.get(Selection.class);</a>
<span class="sourceLineNo">797</span><a name="line.797">            if (selection != null) {</a>
<span class="sourceLineNo">798</span><a name="line.798">                supportedLocales.stream()</a>
<span class="sourceLineNo">799</span><a name="line.799">                    .filter(lang -&gt; lang.equals(event.locale())).findFirst()</a>
<span class="sourceLineNo">800</span><a name="line.800">                    .ifPresent(lang -&gt; selection.prefer(lang));</a>
<span class="sourceLineNo">801</span><a name="line.801">            }</a>
<span class="sourceLineNo">802</span><a name="line.802">        }</a>
<span class="sourceLineNo">803</span><a name="line.803">        channel.respond(new SimplePortalCommand("reload"));</a>
<span class="sourceLineNo">804</span><a name="line.804">    }</a>
<span class="sourceLineNo">805</span><a name="line.805"></a>
<span class="sourceLineNo">806</span><a name="line.806">    /**</a>
<span class="sourceLineNo">807</span><a name="line.807">     * Handles a change of theme.</a>
<span class="sourceLineNo">808</span><a name="line.808">     *</a>
<span class="sourceLineNo">809</span><a name="line.809">     * @param event the event</a>
<span class="sourceLineNo">810</span><a name="line.810">     * @param channel the channel</a>
<span class="sourceLineNo">811</span><a name="line.811">     * @throws InterruptedException the interrupted exception</a>
<span class="sourceLineNo">812</span><a name="line.812">     * @throws IOException Signals that an I/O exception has occurred.</a>
<span class="sourceLineNo">813</span><a name="line.813">     */</a>
<span class="sourceLineNo">814</span><a name="line.814">    @Handler(channels = PortalChannel.class)</a>
<span class="sourceLineNo">815</span><a name="line.815">    public void onSetTheme(SetTheme event, PortalSession channel)</a>
<span class="sourceLineNo">816</span><a name="line.816">            throws InterruptedException, IOException {</a>
<span class="sourceLineNo">817</span><a name="line.817">        ThemeProvider themeProvider = StreamSupport</a>
<span class="sourceLineNo">818</span><a name="line.818">            .stream(themeLoader().spliterator(), false)</a>
<span class="sourceLineNo">819</span><a name="line.819">            .filter(thi -&gt; thi.themeId().equals(event.theme())).findFirst()</a>
<span class="sourceLineNo">820</span><a name="line.820">            .orElse(baseTheme);</a>
<span class="sourceLineNo">821</span><a name="line.821">        channel.browserSession().put("themeProvider", themeProvider.themeId());</a>
<span class="sourceLineNo">822</span><a name="line.822">        channel.respond(new KeyValueStoreUpdate().update(</a>
<span class="sourceLineNo">823</span><a name="line.823">            "/" + Utils.userFromSession(channel.browserSession())</a>
<span class="sourceLineNo">824</span><a name="line.824">                .map(UserPrincipal::toString).orElse("")</a>
<span class="sourceLineNo">825</span><a name="line.825">                + "/themeProvider",</a>
<span class="sourceLineNo">826</span><a name="line.826">            themeProvider.themeId())).get();</a>
<span class="sourceLineNo">827</span><a name="line.827">        channel.respond(new SimplePortalCommand("reload"));</a>
<span class="sourceLineNo">828</span><a name="line.828">    }</a>
<span class="sourceLineNo">829</span><a name="line.829"></a>
<span class="sourceLineNo">830</span><a name="line.830">    /**</a>
<span class="sourceLineNo">831</span><a name="line.831">     * Sends a command to the portal.</a>
<span class="sourceLineNo">832</span><a name="line.832">     *</a>
<span class="sourceLineNo">833</span><a name="line.833">     * @param event the event</a>
<span class="sourceLineNo">834</span><a name="line.834">     * @param channel the channel</a>
<span class="sourceLineNo">835</span><a name="line.835">     * @throws InterruptedException the interrupted exception</a>
<span class="sourceLineNo">836</span><a name="line.836">     * @throws IOException Signals that an I/O exception has occurred.</a>
<span class="sourceLineNo">837</span><a name="line.837">     */</a>
<span class="sourceLineNo">838</span><a name="line.838">    @Handler(channels = PortalChannel.class, priority = -1000)</a>
<span class="sourceLineNo">839</span><a name="line.839">    public void onPortalCommand(</a>
<span class="sourceLineNo">840</span><a name="line.840">            PortalCommand event, PortalSession channel)</a>
<span class="sourceLineNo">841</span><a name="line.841">            throws InterruptedException, IOException {</a>
<span class="sourceLineNo">842</span><a name="line.842">        IOSubchannel upstream = channel.upstreamChannel();</a>
<span class="sourceLineNo">843</span><a name="line.843">        @SuppressWarnings("resource")</a>
<span class="sourceLineNo">844</span><a name="line.844">        CharBufferWriter out = new CharBufferWriter(upstream,</a>
<span class="sourceLineNo">845</span><a name="line.845">            upstream.responsePipeline()).suppressClose();</a>
<span class="sourceLineNo">846</span><a name="line.846">        event.toJson(out);</a>
<span class="sourceLineNo">847</span><a name="line.847">    }</a>
<span class="sourceLineNo">848</span><a name="line.848"></a>
<span class="sourceLineNo">849</span><a name="line.849">    /**</a>
<span class="sourceLineNo">850</span><a name="line.850">     * Holds the information about the selected language.</a>
<span class="sourceLineNo">851</span><a name="line.851">     */</a>
<span class="sourceLineNo">852</span><a name="line.852">    public static class LanguageInfo {</a>
<span class="sourceLineNo">853</span><a name="line.853">        private final Locale locale;</a>
<span class="sourceLineNo">854</span><a name="line.854"></a>
<span class="sourceLineNo">855</span><a name="line.855">        /**</a>
<span class="sourceLineNo">856</span><a name="line.856">         * Instantiates a new language info.</a>
<span class="sourceLineNo">857</span><a name="line.857">         *</a>
<span class="sourceLineNo">858</span><a name="line.858">         * @param locale the locale</a>
<span class="sourceLineNo">859</span><a name="line.859">         */</a>
<span class="sourceLineNo">860</span><a name="line.860">        public LanguageInfo(Locale locale) {</a>
<span class="sourceLineNo">861</span><a name="line.861">            this.locale = locale;</a>
<span class="sourceLineNo">862</span><a name="line.862">        }</a>
<span class="sourceLineNo">863</span><a name="line.863"></a>
<span class="sourceLineNo">864</span><a name="line.864">        /**</a>
<span class="sourceLineNo">865</span><a name="line.865">         * Gets the locale.</a>
<span class="sourceLineNo">866</span><a name="line.866">         *</a>
<span class="sourceLineNo">867</span><a name="line.867">         * @return the locale</a>
<span class="sourceLineNo">868</span><a name="line.868">         */</a>
<span class="sourceLineNo">869</span><a name="line.869">        public Locale getLocale() {</a>
<span class="sourceLineNo">870</span><a name="line.870">            return locale;</a>
<span class="sourceLineNo">871</span><a name="line.871">        }</a>
<span class="sourceLineNo">872</span><a name="line.872"></a>
<span class="sourceLineNo">873</span><a name="line.873">        /**</a>
<span class="sourceLineNo">874</span><a name="line.874">         * Gets the label.</a>
<span class="sourceLineNo">875</span><a name="line.875">         *</a>
<span class="sourceLineNo">876</span><a name="line.876">         * @return the label</a>
<span class="sourceLineNo">877</span><a name="line.877">         */</a>
<span class="sourceLineNo">878</span><a name="line.878">        public String getLabel() {</a>
<span class="sourceLineNo">879</span><a name="line.879">            String str = locale.getDisplayName(locale);</a>
<span class="sourceLineNo">880</span><a name="line.880">            return Character.toUpperCase(str.charAt(0)) + str.substring(1);</a>
<span class="sourceLineNo">881</span><a name="line.881">        }</a>
<span class="sourceLineNo">882</span><a name="line.882">    }</a>
<span class="sourceLineNo">883</span><a name="line.883"></a>
<span class="sourceLineNo">884</span><a name="line.884">    /**</a>
<span class="sourceLineNo">885</span><a name="line.885">     * Holds the information about a theme.</a>
<span class="sourceLineNo">886</span><a name="line.886">     */</a>
<span class="sourceLineNo">887</span><a name="line.887">    public static class ThemeInfo implements Comparable&lt;ThemeInfo&gt; {</a>
<span class="sourceLineNo">888</span><a name="line.888">        private final String id;</a>
<span class="sourceLineNo">889</span><a name="line.889">        private final String name;</a>
<span class="sourceLineNo">890</span><a name="line.890"></a>
<span class="sourceLineNo">891</span><a name="line.891">        /**</a>
<span class="sourceLineNo">892</span><a name="line.892">         * Instantiates a new theme info.</a>
<span class="sourceLineNo">893</span><a name="line.893">         *</a>
<span class="sourceLineNo">894</span><a name="line.894">         * @param id the id</a>
<span class="sourceLineNo">895</span><a name="line.895">         * @param name the name</a>
<span class="sourceLineNo">896</span><a name="line.896">         */</a>
<span class="sourceLineNo">897</span><a name="line.897">        public ThemeInfo(String id, String name) {</a>
<span class="sourceLineNo">898</span><a name="line.898">            super();</a>
<span class="sourceLineNo">899</span><a name="line.899">            this.id = id;</a>
<span class="sourceLineNo">900</span><a name="line.900">            this.name = name;</a>
<span class="sourceLineNo">901</span><a name="line.901">        }</a>
<span class="sourceLineNo">902</span><a name="line.902"></a>
<span class="sourceLineNo">903</span><a name="line.903">        /**</a>
<span class="sourceLineNo">904</span><a name="line.904">         * Returns the id.</a>
<span class="sourceLineNo">905</span><a name="line.905">         *</a>
<span class="sourceLineNo">906</span><a name="line.906">         * @return the id</a>
<span class="sourceLineNo">907</span><a name="line.907">         */</a>
<span class="sourceLineNo">908</span><a name="line.908">        @SuppressWarnings("PMD.ShortMethodName")</a>
<span class="sourceLineNo">909</span><a name="line.909">        public String id() {</a>
<span class="sourceLineNo">910</span><a name="line.910">            return id;</a>
<span class="sourceLineNo">911</span><a name="line.911">        }</a>
<span class="sourceLineNo">912</span><a name="line.912"></a>
<span class="sourceLineNo">913</span><a name="line.913">        /**</a>
<span class="sourceLineNo">914</span><a name="line.914">         * Returns the name.</a>
<span class="sourceLineNo">915</span><a name="line.915">         *</a>
<span class="sourceLineNo">916</span><a name="line.916">         * @return the name</a>
<span class="sourceLineNo">917</span><a name="line.917">         */</a>
<span class="sourceLineNo">918</span><a name="line.918">        public String name() {</a>
<span class="sourceLineNo">919</span><a name="line.919">            return name;</a>
<span class="sourceLineNo">920</span><a name="line.920">        }</a>
<span class="sourceLineNo">921</span><a name="line.921"></a>
<span class="sourceLineNo">922</span><a name="line.922">        /*</a>
<span class="sourceLineNo">923</span><a name="line.923">         * (non-Javadoc)</a>
<span class="sourceLineNo">924</span><a name="line.924">         * </a>
<span class="sourceLineNo">925</span><a name="line.925">         * @see java.lang.Comparable#compareTo(java.lang.Object)</a>
<span class="sourceLineNo">926</span><a name="line.926">         */</a>
<span class="sourceLineNo">927</span><a name="line.927">        @Override</a>
<span class="sourceLineNo">928</span><a name="line.928">        public int compareTo(ThemeInfo other) {</a>
<span class="sourceLineNo">929</span><a name="line.929">            return name().compareToIgnoreCase(other.name());</a>
<span class="sourceLineNo">930</span><a name="line.930">        }</a>
<span class="sourceLineNo">931</span><a name="line.931">    }</a>
<span class="sourceLineNo">932</span><a name="line.932"></a>
<span class="sourceLineNo">933</span><a name="line.933">    /**</a>
<span class="sourceLineNo">934</span><a name="line.934">     * Create a {@link URI} from a path. This is similar to calling</a>
<span class="sourceLineNo">935</span><a name="line.935">     * `new URI(null, null, path, null)` with the {@link URISyntaxException}</a>
<span class="sourceLineNo">936</span><a name="line.936">     * converted to a {@link IllegalArgumentException}.</a>
<span class="sourceLineNo">937</span><a name="line.937">     * </a>
<span class="sourceLineNo">938</span><a name="line.938">     * @param path the path</a>
<span class="sourceLineNo">939</span><a name="line.939">     * @return the uri</a>
<span class="sourceLineNo">940</span><a name="line.940">     * @throws IllegalArgumentException if the string violates </a>
<span class="sourceLineNo">941</span><a name="line.941">     * RFC 2396</a>
<span class="sourceLineNo">942</span><a name="line.942">     */</a>
<span class="sourceLineNo">943</span><a name="line.943">    public static URI uriFromPath(String path) throws IllegalArgumentException {</a>
<span class="sourceLineNo">944</span><a name="line.944">        try {</a>
<span class="sourceLineNo">945</span><a name="line.945">            return new URI(null, null, path, null);</a>
<span class="sourceLineNo">946</span><a name="line.946">        } catch (URISyntaxException e) {</a>
<span class="sourceLineNo">947</span><a name="line.947">            throw new IllegalArgumentException(e);</a>
<span class="sourceLineNo">948</span><a name="line.948">        }</a>
<span class="sourceLineNo">949</span><a name="line.949">    }</a>
<span class="sourceLineNo">950</span><a name="line.950"></a>
<span class="sourceLineNo">951</span><a name="line.951">    /**</a>
<span class="sourceLineNo">952</span><a name="line.952">     * The channel used to send {@link PageResourceRequest}s and</a>
<span class="sourceLineNo">953</span><a name="line.953">     * {@link PortletResourceRequest}s to the portlets (via the</a>
<span class="sourceLineNo">954</span><a name="line.954">     * portal).</a>
<span class="sourceLineNo">955</span><a name="line.955">     */</a>
<span class="sourceLineNo">956</span><a name="line.956">    public class PortalResourceChannel extends LinkedIOSubchannel {</a>
<span class="sourceLineNo">957</span><a name="line.957"></a>
<span class="sourceLineNo">958</span><a name="line.958">        /**</a>
<span class="sourceLineNo">959</span><a name="line.959">         * Instantiates a new portal resource channel.</a>
<span class="sourceLineNo">960</span><a name="line.960">         *</a>
<span class="sourceLineNo">961</span><a name="line.961">         * @param hub the hub</a>
<span class="sourceLineNo">962</span><a name="line.962">         * @param upstreamChannel the upstream channel</a>
<span class="sourceLineNo">963</span><a name="line.963">         * @param responsePipeline the response pipeline</a>
<span class="sourceLineNo">964</span><a name="line.964">         */</a>
<span class="sourceLineNo">965</span><a name="line.965">        public PortalResourceChannel(Manager hub,</a>
<span class="sourceLineNo">966</span><a name="line.966">                IOSubchannel upstreamChannel, EventPipeline responsePipeline) {</a>
<span class="sourceLineNo">967</span><a name="line.967">            super(hub, hub.channel(), upstreamChannel, responsePipeline);</a>
<span class="sourceLineNo">968</span><a name="line.968">        }</a>
<span class="sourceLineNo">969</span><a name="line.969">    }</a>
<span class="sourceLineNo">970</span><a name="line.970"></a>
<span class="sourceLineNo">971</span><a name="line.971">    /**</a>
<span class="sourceLineNo">972</span><a name="line.972">     * The implementation of {@link RenderSupport} used by this class.</a>
<span class="sourceLineNo">973</span><a name="line.973">     */</a>
<span class="sourceLineNo">974</span><a name="line.974">    private class RenderSupportImpl implements RenderSupport {</a>
<span class="sourceLineNo">975</span><a name="line.975"></a>
<span class="sourceLineNo">976</span><a name="line.976">        /*</a>
<span class="sourceLineNo">977</span><a name="line.977">         * (non-Javadoc)</a>
<span class="sourceLineNo">978</span><a name="line.978">         * </a>
<span class="sourceLineNo">979</span><a name="line.979">         * @see</a>
<span class="sourceLineNo">980</span><a name="line.980">         * org.jgrapes.portal.RenderSupport#portletResource(java.lang.String,</a>
<span class="sourceLineNo">981</span><a name="line.981">         * java.net.URI)</a>
<span class="sourceLineNo">982</span><a name="line.982">         */</a>
<span class="sourceLineNo">983</span><a name="line.983">        @Override</a>
<span class="sourceLineNo">984</span><a name="line.984">        public URI portletResource(String portletType, URI uri) {</a>
<span class="sourceLineNo">985</span><a name="line.985">            return portal.prefix().resolve(uriFromPath(</a>
<span class="sourceLineNo">986</span><a name="line.986">                "portlet-resource/" + portletType + "/")).resolve(uri);</a>
<span class="sourceLineNo">987</span><a name="line.987">        }</a>
<span class="sourceLineNo">988</span><a name="line.988"></a>
<span class="sourceLineNo">989</span><a name="line.989">        /*</a>
<span class="sourceLineNo">990</span><a name="line.990">         * (non-Javadoc)</a>
<span class="sourceLineNo">991</span><a name="line.991">         * </a>
<span class="sourceLineNo">992</span><a name="line.992">         * @see org.jgrapes.portal.RenderSupport#pageResource(java.net.URI)</a>
<span class="sourceLineNo">993</span><a name="line.993">         */</a>
<span class="sourceLineNo">994</span><a name="line.994">        @Override</a>
<span class="sourceLineNo">995</span><a name="line.995">        public URI pageResource(URI uri) {</a>
<span class="sourceLineNo">996</span><a name="line.996">            return portal.prefix().resolve(uriFromPath(</a>
<span class="sourceLineNo">997</span><a name="line.997">                "page-resource/")).resolve(uri);</a>
<span class="sourceLineNo">998</span><a name="line.998">        }</a>
<span class="sourceLineNo">999</span><a name="line.999"></a>
<span class="sourceLineNo">1000</span><a name="line.1000">        /*</a>
<span class="sourceLineNo">1001</span><a name="line.1001">         * (non-Javadoc)</a>
<span class="sourceLineNo">1002</span><a name="line.1002">         * </a>
<span class="sourceLineNo">1003</span><a name="line.1003">         * @see org.jgrapes.portal.RenderSupport#useMinifiedResources()</a>
<span class="sourceLineNo">1004</span><a name="line.1004">         */</a>
<span class="sourceLineNo">1005</span><a name="line.1005">        @Override</a>
<span class="sourceLineNo">1006</span><a name="line.1006">        public boolean useMinifiedResources() {</a>
<span class="sourceLineNo">1007</span><a name="line.1007">            return useMinifiedResources;</a>
<span class="sourceLineNo">1008</span><a name="line.1008">        }</a>
<span class="sourceLineNo">1009</span><a name="line.1009"></a>
<span class="sourceLineNo">1010</span><a name="line.1010">    }</a>
<span class="sourceLineNo">1011</span><a name="line.1011"></a>
<span class="sourceLineNo">1012</span><a name="line.1012">}</a>




























































</pre>
</div>
</body>
</html>
